<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Teacher Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
      color: white;
      padding-left: 70px;
      transition: padding-left 0.3s ease;
    }

    .header-bar {
      width: 100%;
      text-align: center;
      background: linear-gradient(to right, #0072ff, #00c6ff);
      padding: 1px 0;
      color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      position: sticky;
      top: 0;
      z-index: 998;
      display: none;
    }

    .header-bar i {
      margin-right: 10px;
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: 70px;
      background: rgba(255, 255, 255, 0.08);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 20px;
      backdrop-filter: blur(5px);
      transition: width 0.3s ease;
      z-index: 999;
    }

    .sidebar:hover {
      width: 180px;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
      width: 100%;
    }

    .sidebar li {
      display: flex;
      align-items: center;
      padding: 15px 10px;
      cursor: pointer;
      color: #fff;
      transition: background 0.2s ease;
    }

    .sidebar li:hover {
      background-color: rgba(0, 198, 255, 0.15);
    }

    .sidebar i {
      font-size: 18px;
      margin-right: 10px;
      min-width: 30px;
      text-align: center;
    }

    .sidebar span {
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .sidebar:hover span {
      opacity: 1;
    }


    /* ============ Move content right ============ */

    .sidebar:hover~body {
      padding-left: 180px;
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 60px;
      }

      .sidebar:hover {
        width: 160px;
      }

      body {
        padding-left: 60px;
      }

      .sidebar:hover~body {
        padding-left: 160px;
      }
    }


    .section {
      display: none;
      padding: 30px;
    }

    .section.active {
      display: block;
    }

    input,
    button,
    select {
      padding: 10px;
      border-radius: 6px;
      border: none;
      margin-top: 10px;
      width: 100%;
      box-sizing: border-box;
    }

    button {
      background: linear-gradient(to right, #00c6ff, #0072ff);
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    button:hover {
      box-shadow: 0 5px 10px rgba(0, 198, 255, 0.3);
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      background-color: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: 10px;
      margin-top: 30px;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }

    /* Developers Section Styling */
    #developers {
      background-color: rgba(255, 255, 255, 0.05);
      color: whitesmoke;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      border-radius: 18px;
      padding: 36px 32px 32px 32px;
      margin-top: 40px;
      max-width: 650px;
      margin-left: auto;
      margin-right: auto;
      font-size: 1.08em;
      position: relative;
    }
    #developers h3 {
      color: #0072ff;
      font-size: 2em;
      margin-bottom: 10px;
      letter-spacing: 1px;
    }
    #developers h4 {
      color: #00c6ff;
      margin-top: 24px;
      margin-bottom: 10px;
      font-size: 1.15em;
    }
    #developers ul {
      padding-left: 20px;
      margin-bottom: 0;
    }
    #developers li {
      margin-bottom: 7px;
      line-height: 1.7;
    }
    #developers li strong {
      color: #0072ff;
    }
    #developers a {
      color: #00c6ff;
      text-decoration: none;
      transition: color 0.2s;
    }
    #developers a:hover {
      color: #0072ff;
      text-decoration: underline;
    }
    #developers .dev-role {
      background: #e3f2fd;
      color: #0072ff;
      border-radius: 8px;
      padding: 2px 10px;
      font-size: 0.95em;
      margin-left: 8px;
    }
    #developers .dev-contact {
      margin-top: 18px;
      font-size: 1em;
      color: whitesmoke;
    }
    #developers .dev-stack {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 18px;
      margin-bottom: 10px;
    }
    #developers .dev-stack li {
      background: #f0f7ff;
      border-radius: 6px;
      padding: 4px 12px;
      color: #0072ff;
      font-size: 0.98em;
      margin-bottom: 0;
    }
    #developers .dev-icon {
      margin-right: 7px;
      color: #00c6ff;
      font-size: 1.1em;
    }
  </style>
</head>

<script>
  function getApiBaseUrl() {
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      return 'http://localhost:5000';
    } else {
      return 'https://geo-attendance-system.onrender.com';
    }
  }
  const API_BASE_URL = getApiBaseUrl();

  let isLocationCaptured = false;

  // Browser detection utility
  function detectBrowser() {
    const userAgent = navigator.userAgent;
    
    // A more robust check for Chrome that excludes other Chromium browsers like Edge and Opera
    const isChrome = /Chrome/.test(userAgent) && !/Edg/.test(userAgent) && !/OPR/.test(userAgent);
    
    return {
      isChrome: isChrome,
      browserName: getBrowserName(userAgent)
    };
  }

  function getBrowserName(userAgent) {
    if (/Edg/.test(userAgent)) {
      return 'Edge';
    }
    if (/OPR/.test(userAgent) || /Opera/.test(userAgent)) {
      return 'Opera';
    }
    if (/Firefox/.test(userAgent)) {
      return 'Firefox';
    }
    if (/Chrome/.test(userAgent)) {
      return 'Chrome';
    }
    if (/Safari/.test(userAgent)) {
      return 'Safari';
    }
    return 'Unknown';
  }

  function showChromeOnlyMessage() {
    const browserInfo = detectBrowser();
    
    if (!browserInfo.isChrome) {
      // Create overlay
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      `;
      
      overlay.innerHTML = `
        <div style="
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          padding: 40px;
          border-radius: 20px;
          text-align: center;
          max-width: 500px;
          margin: 20px;
          box-shadow: 0 20px 40px rgba(0,0,0,0.3);
          color: white;
        ">
          <div style="font-size: 48px; margin-bottom: 20px;">🚫</div>
          <h2 style="margin-bottom: 20px; color: #fff;">Browser Not Supported</h2>
          <p style="margin-bottom: 20px; line-height: 1.6;">
            You are currently using <strong>${browserInfo.browserName}</strong>.
            <br><br>
            This application requires <strong>Google Chrome</strong> for optimal functionality and security.
          </p>
          <div style="
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #4CAF50;
          ">
            <h3 style="margin: 0 0 10px 0; color: #4CAF50;">Why Chrome Only?</h3>
            <ul style="text-align: left; margin: 0; padding-left: 20px;">
              <li>Better geolocation accuracy</li>
              <li>Enhanced security features</li>
              <li>Consistent performance</li>
              <li>Optimal compatibility</li>
            </ul>
          </div>
          <div style="margin-top: 30px;">
            <a href="https://www.google.com/chrome/" target="_blank" style="
              background: #4CAF50;
              color: white;
              padding: 12px 24px;
              text-decoration: none;
              border-radius: 25px;
              display: inline-block;
              margin: 0 10px;
              transition: all 0.3s ease;
            " onmouseover="this.style.background='#45a049'" onmouseout="this.style.background='#4CAF50'">
              Download Chrome
            </a>
            <button onclick="logout()" style="
              background: rgba(255,255,255,0.2);
              color: white;
              padding: 12px 24px;
              border: none;
              border-radius: 25px;
              cursor: pointer;
              margin: 0 10px;
              transition: all 0.3s ease;
            " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
              Logout
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      return false;
    }
    
    return true;
  }

  // ============ Block access if not logged in ============ 

  document.addEventListener("DOMContentLoaded", () => {
    // Check browser first
    if (!showChromeOnlyMessage()) {
      return; // Stop execution if not Chrome
    }
    
    const token = localStorage.getItem("token");
    const role = localStorage.getItem("role");

    if (!token || role !== "teacher") {
      alert("Unauthorized access. Please log in.");
      window.location.href = "index.html";
    }

    // ============ Prevent going back to dashboard after logout ============ 

    window.history.pushState(null, null, window.location.href);
    window.onpopstate = function () {
      window.history.go(1);
    };
  });

</script>

<body>
  <!-- ============ Sidebar ============ -->

  <div class="sidebar">
    <ul>
      <li onclick="showSection('overview')" title="Dashboard">
        <i class="fas fa-home"></i>
        <span>Dashboard</span>
      </li>
      <li onclick="showSection('add-student')" title="Add Student">
        <i class="fas fa-user-plus"></i>
        <span>Add Student</span>
      </li>
      <li onclick="showSection('view-students')" title="View Students">
        <i class="fas fa-users"></i>
        <span>View Students</span>
      </li>
      <li onclick="showSection('archived-slots')" title="Archived Slots">
        <i class="fas fa-archive"></i>
        <span>Archived Slots</span>
      </li>
      <li onclick="showSection('attendance-setup')" title="Attendance Setup">
        <i class="fas fa-map-marker-alt"></i>
        <span>Attendance</span>
      </li>
      <li onclick="showSection('download')" title="Download Sheet">
        <i class="fas fa-file-download"></i>
        <span>Download</span>
      </li>
      <li onclick="showSection('developers')" title="Developers">
        <i class="fas fa-code"></i>
        <span>Developers</span>
      </li>
      <li onclick="logout()" title="Logout">
        <i class="fas fa-sign-out-alt"></i>
        <span>Logout</span>
      </li>
    </ul>
  </div>


  <!-- ============ Overview ============ -->

  <div id="overview" class="section active container">
    <h3 id="greetingText">Welcome 👩‍🏫</h3>
    <p>Use the navigation left to manage students and attendance.</p>
  </div>


  <!-- ============ Add Student Section ============ -->

  <div id="add-student" class="section container">
    <h3>Add Students</h3>

    <form id="addStudentForm">
      <label>Student Name</label>
      <input type="text" name="name" required>

      <label>Email (used as username)</label>
      <input type="email" name="email" required>

      <label>Registration Number (used as password)</label>
      <input type="text" name="regno" required>

      <label>Slot (e.g., A11+A12)</label>
      <input type="text" name="slot" placeholder="e.g., A11+A12" required>

      <button type="submit">Add Student</button>
    </form>


    <hr style="margin: 30px 0; border: 1px solid #ffffff22;">

    <label>Upload Excel (.xlsx) File</label>
    <input type="file" accept=".xlsx" id="excelFileInput" />
    <button onclick="uploadExcel()">Upload Excel</button>

  </div>


  <!-- ============ View Student ============ -->

  <div id="view-students" class="section container">
    <h3>All Students</h3>

    <label for="slotFilter">Filter by Slot</label>
    <select id="slotFilter" onchange="fetchStudentsBySlot()">
      <option value="">-- Select Slot --</option>
    </select>

    <button onclick="deleteAllInSlot()">Delete All Students in Selected Slot</button>

    <button onclick="archiveSlot()" style="background: linear-gradient(to right, #ff9800, #f57c00);">Archive Slot</button>

    <div id="studentList">Loading...</div>

  </div>

  <!-- ============ Archived Slots ============ -->

  <div id="archived-slots" class="section container">
    <h3>Archived Slots</h3>

    <label for="archivedSlotFilter">Filter by Archived Slot</label>
    <select id="archivedSlotFilter" onchange="fetchArchivedStudentsBySlot()">
      <option value="">-- Select Archived Slot --</option>
    </select>

    <div id="archivedStudentList">Loading...</div>

  </div>


  <!-- ============ Attendance setup ============ -->

  <div id="attendance-setup" class="section container">
    <h3>Attendance Setup</h3>

    <label>Select Main Slot</label>
    <select id="attendanceSlot" onchange="handleMainSlotChange()">
      <option value="">-- Select Slot --</option>
    </select>

    <label>Select Individual Slot</label>
    <select id="individualSlot">
      <option value="">-- Select Individual Slot --</option>
    </select>

    <label>Allowed Radius (in meters)</label>
    <input type="number" id="radiusInput" placeholder="Enter radius e.g. 100" />

    <label>Latitude</label>
    <input type="text" id="latitude" readonly placeholder="Auto-detected latitude" />

    <label>Longitude</label>
    <input type="text" id="longitude" readonly placeholder="Auto-detected longitude" />

    <label>Start Time</label>
    <input type="time" id="startTimeInput" />

    <label>End Time</label>
    <input type="time" id="endTimeInput" />

    <button onclick="saveAttendanceSettings()">Save Settings</button>

    <p id="radiusSavedMsg" style="margin-top: 10px; color: #4caf50;"></p>
    <div id="live-count-section" style="display:none; margin-top:20px; padding:15px; background:#f5faff; border-radius:8px; color:#0072ff; font-weight:bold;">
      <span id="live-count-loading">Loading live attendance count...</span>
      <span id="live-count-display" style="display:none;"></span>
    </div>
  </div>



  <!-- ============ Dowload the report ============ -->

  <div id="download" class="section container">
    <h3>Download Attendance Sheet</h3>

    <label for="downloadMainSlot">Select Main Slot</label>
    <select id="downloadMainSlot" onchange="handleDownloadMainSlotChange()">
      <option value="">-- Select Main Slot --</option>
    </select>

    <label for="downloadIndividualSlot">Select Individual Slot</label>
    <select id="downloadIndividualSlot">
      <option value="">-- Select Individual Slot --</option>
    </select>

    <label for="downloadDate">Select Date</label>
    <input type="date" id="downloadDate" />

    <button onclick="downloadSheet()">Download Report</button>

    <p id="download-message"></p>
  </div>

  <!-- ============ Developers Section ============ -->
  
  <div id="developers" class="section container">
    <h3><i class="fas fa-users dev-icon"></i> About the Developers</h3>
    <p><strong>Project:</strong> Attendance Management System</p>
    <p><strong>Version:</strong> 1.0.0</p>
    <p><strong>Description:</strong> A modern, secure, and location-based attendance system for educational institutions.</p>
    <h4><i class="fas fa-user-friends dev-icon"></i> Developers</h4>
    <ul>
      <li><strong>Shubham Raj Sharma (22BCY10200)</strong> <span class="dev-role">Full Stack Developer</span> (<a href="mailto:shubhamraj100802@gmail.com">Email</a>, <a href="https://www.linkedin.com/in/shubhamraj100802/" target="_blank">LinkedIn</a>)</li>
    </ul>
    <h4 style="color:#00c6ff; margin-top:18px; margin-bottom:8px;"><i class="fas fa-user-tie dev-icon"></i> Faculty Mentor</h4>
    <ul>
      <li><strong style="color:#0072ff;">Dr. Sajjad Ahmed Sir</strong></li>
    </ul>
    <h4><i class="fas fa-cogs dev-icon"></i> Tech Stack</h4>
    <ul class="dev-stack">
      <li><i class="fab fa-node-js dev-icon"></i>Node.js</li>
      <li><i class="fas fa-server dev-icon"></i>Express.js</li>
      <li><i class="fas fa-database dev-icon"></i>MongoDB, Mongoose</li>
      <li><i class="fab fa-html5 dev-icon"></i>HTML</li>
      <li><i class="fab fa-css3-alt dev-icon"></i>CSS</li>
      <li><i class="fab fa-js dev-icon"></i>JavaScript</li>
      <li><i class="fas fa-key dev-icon"></i>JWT, bcryptjs</li>
      <li><i class="fas fa-file-excel dev-icon"></i>xlsx</li>
    </ul>
    <h4><i class="fas fa-envelope dev-icon"></i> Contact & Support</h4>
    <p class="dev-contact">For support or feedback, contact 
      <a href="mailto:shubhamraj100802@gmail.com"><i class="fas fa-envelope" style="color:#0072ff;"></i> Email</a> &nbsp;|&nbsp; 
      <a href="https://www.instagram.com/itsmeshubh2026?igsh=MW51dXh1ZHc4bjY5Ng==" target="_blank" style="color:#E1306C;"><i class="fab fa-instagram"></i> Instagram</a>
    </p>
  </div>

</body>

<script>

  // ============ Capture the latitude and longitude ===========


  let detectedLatitude = null;
  let detectedLongitude = null;

  function captureTeacherLocation() {
    const latField = document.getElementById("latitude");
    const lngField = document.getElementById("longitude");

    if (!navigator.geolocation) {
      alert("Geolocation is not supported by your browser.");
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (position) => {
        latField.value = position.coords.latitude.toFixed(6);
        lngField.value = position.coords.longitude.toFixed(6);
        console.log(" Location captured:", latField.value, lngField.value);
      },
      (error) => {
        alert(" Location access denied or unavailable. Please allow GPS access.");
        console.error("Geolocation error:", error);
      }
    );
  }

  document.addEventListener("DOMContentLoaded", () => {
    captureTeacherLocation(); 
  });


</script>

<script>
  function showSection(sectionId) {
    document.querySelectorAll(".section").forEach(section => {
      section.classList.remove("active");
    });
    document.getElementById(sectionId).classList.add("active");

    if (sectionId === "attendance-setup") {
      captureTeacherLocation();
      populateAttendanceSlotDropdown();
    }

    if (sectionId === "download") {
      populateDownloadMainSlots();
    }

    if (sectionId === "view-students") {
      fetchSlots();
      fetchStudentsBySlot();
    }

    if (sectionId === "archived-slots") {
      fetchArchivedSlots();
      fetchArchivedStudentsBySlot();
    }

    if (sectionId === "developers") {
      // No special logic needed, just show the section
    }
  }



  function logout() {
    localStorage.removeItem("token");
    localStorage.removeItem("role");
    alert("Logging out...");
    window.location.href = "index.html";
  }

  function downloadExcel() {
    alert("Downloading attendance sheet...");
  }

  // ============ Add Student Form Submission ============ //

  const addStudentForm = document.getElementById("addStudentForm");
  addStudentForm.addEventListener("submit", async function (e) {
    e.preventDefault();

    const name = addStudentForm.name.value;
    const email = addStudentForm.email.value;
    const regno = addStudentForm.regno.value;
    const slot = addStudentForm.slot.value;

    try {
      const res = await fetch(`${API_BASE_URL}/teacher/add-student`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${localStorage.getItem("token")}`,
        },
        body: JSON.stringify({ name, email, regNo: regno, slot }),
      });

      const data = await res.json();

      if (res.ok) {
        alert("Student added!");
        addStudentForm.reset();
      } else {
        alert(data.message || "Failed to add student");
      }
    } catch (err) {
      alert("Error occurred");
      console.error(err);
    }
  });


  // ============ Redirect to login if not logged in and Dynamic Greeting with name ============ //

  document.addEventListener("DOMContentLoaded", () => {
    const name = localStorage.getItem("name");
    const token = localStorage.getItem("token");
    const role = localStorage.getItem("role");

    if (!token || role !== "teacher") {
      alert("Unauthorized access. Please log in as a teacher.");
      window.location.href = "index.html";
      return;
    }

    // Greeting
    const greetingText = document.getElementById("greetingText");
    const hour = new Date().getHours();
    let greeting = "Hello";

    if (hour >= 5 && hour < 12) {
      greeting = "Good Morning";
    } else if (hour >= 12 && hour < 17) {
      greeting = "Good Afternoon";
    } else {
      greeting = "Good Evening";
    }

    greetingText.innerText = `${greeting}, ${name || "Teacher"} 👩‍🏫`;
  });



</script>

<script>

  //  ============ To upload xl ============ //

  async function uploadExcel() {
    const fileInput = document.getElementById("excelFileInput");
    const file = fileInput.files[0];

    if (!file) {
      alert("Please select an Excel (.xlsx) file first.");
      return;
    }

    const formData = new FormData();
    formData.append("file", file);

    try {
      const res = await fetch(`${API_BASE_URL}/teacher/upload-students`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${localStorage.getItem("token")}`,
        },
        body: formData,
      });

      const data = await res.json();

      if (res.ok) {
        alert(" Students uploaded successfully!");
      } else {
        alert(data.message || "Failed to upload students");
      }
    } catch (err) {
      console.error(err);
      alert("Something went wrong during upload.");
    }
  }
</script>

<script>

  // ============= To view Students Slot Wise =============

  async function fetchSlots() {
    try {
      const res = await fetch(`${API_BASE_URL}/teacher/slots`, {
        headers: {
          Authorization: `Bearer ${localStorage.getItem('token')}`,
        },
      });
      const slots = await res.json();
      const slotDropdown = document.getElementById('slotFilter');

      slotDropdown.innerHTML = '<option value="">-- Select Slot --</option>';

      slots.forEach(slot => {
        const option = document.createElement('option');
        option.value = slot;
        option.innerText = slot;
        slotDropdown.appendChild(option);
      });
    } catch (err) {
      console.error(' Error fetching slots:', err);
    }
  }


  // ============ Show Students ============

  async function fetchStudentsBySlot() {
    const selectedSlot = document.getElementById('slotFilter').value;
    if (!selectedSlot) {
      document.getElementById('studentList').innerHTML = '<p>Please select a slot to view students.</p>';
      return;
    }

    const url = `${API_BASE_URL}/teacher/students?slot=${encodeURIComponent(selectedSlot)}`;

    try {
      const res = await fetch(url, {
        headers: {
          Authorization: `Bearer ${localStorage.getItem('token')}`,
        },
      });

      const students = await res.json();
      const container = document.getElementById('studentList');
      container.innerHTML = '';

      if (students.length === 0) {
        container.innerHTML = '<p>No students found for this slot.</p>';
        return;
      }

      // Render as table
      let tableHtml = `<table style="width:100%;border-collapse:collapse;table-layout: fixed;">
        <thead>
          <tr style="background:#e6f7ff;color:#0072ff;">
            <th style="padding:8px;">Reg No</th>
            <th style="padding:8px;">Name</th>
            <th style="padding:8px;">Email</th>
            <th style="padding:8px;">Active Slots</th>
            <th style="padding:8px;">Archived Slots</th>
            <th style="padding:8px;">Action</th>
          </tr>
        </thead>
        <tbody>`;
      students.forEach((stu, index) => {
        const activeSlots = Array.isArray(stu.slot) ? stu.slot.join(", ") : stu.slot || "None";
        const archivedSlots = Array.isArray(stu.archivedSlots) ? stu.archivedSlots.join(", ") : stu.archivedSlots || "None";
        
        tableHtml += `<tr style="border-bottom:1px solid #ffffff22;">
          <td style="padding: 12px 8px; vertical-align: middle;">${stu.regNo}</td>
          <td style="padding: 12px 8px; vertical-align: middle; word-wrap: break-word;">${stu.name}</td>
          <td style="padding: 12px 8px; vertical-align: middle; word-wrap: break-word;">${stu.email}</td>
          <td style="padding: 12px 8px; vertical-align: middle; word-wrap: break-word;">${activeSlots}</td>
          <td style="padding: 12px 8px; vertical-align: middle; word-wrap: break-word;">${archivedSlots}</td>
          <td style="padding: 12px 8px; vertical-align: middle;"><button onclick=\"deleteStudent('${stu.regNo}')\">Delete</button></td>
        </tr>`;
      });
      tableHtml += '</tbody></table>';
      container.innerHTML = tableHtml;
    } catch (err) {
      console.error(' Error fetching students:', err);
      document.getElementById('studentList').innerHTML = 'Error loading students.';
    }
  }


  // ============= Delete Student by name ============

  async function deleteStudent(regNo) {
    const selectedSlot = document.getElementById('slotFilter').value;
    if (!confirm(`Delete student with RegNo: ${regNo} from slot: ${selectedSlot}?`)) return;

    try {
      const res = await fetch(`${API_BASE_URL}/teacher/students/${regNo}?slot=${encodeURIComponent(selectedSlot)}`, {
        method: 'DELETE',
        headers: {
          Authorization: `Bearer ${localStorage.getItem("token")}`,
        },
      });

      const data = await res.json();
      alert(data.message || 'Student deleted');
      fetchStudentsBySlot();
    } catch (err) {
      console.error(err);
      alert('Error deleting student');
    }
  }


  // ============ Delete all students ============

  async function deleteAllInSlot() {
    const selectedSlot = document.getElementById('slotFilter').value;
    if (!selectedSlot) return alert('Please select a slot first.');

    if (!confirm(`Delete all students from slot: ${selectedSlot}?`)) return;

    try {
      const res = await fetch(`${API_BASE_URL}/teacher/slots/${encodeURIComponent(selectedSlot)}`, {
        method: 'DELETE',
        headers: {
          Authorization: `Bearer ${localStorage.getItem("token")}`,
        },
      });

      const data = await res.json();
      alert(data.message || 'Deleted');
      fetchSlots();
      fetchStudentsBySlot();
    } catch (err) {
      console.error(err);
      alert('Error deleting slot');
    }
  }

  // ============ Archive Slot ============

  async function archiveSlot() {
    const selectedSlot = document.getElementById('slotFilter').value;
    if (!selectedSlot) return alert('Please select a slot first.');

    if (!confirm(`Archive all students from slot: ${selectedSlot}?`)) return;

    try {
      const res = await fetch(`${API_BASE_URL}/teacher/archive-slot/${encodeURIComponent(selectedSlot)}`, {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${localStorage.getItem("token")}`,
        },
      });

      const data = await res.json();
      if (res.ok) {
        alert(data.message || 'Slot archived successfully');
        fetchSlots();
        fetchStudentsBySlot();
      } else {
        alert(data.message || 'Failed to archive slot');
      }
    } catch (err) {
      console.error(err);
      alert('Error archiving slot');
    }
  }

  // ============ Fetch Archived Slots ============

  async function fetchArchivedSlots() {
    try {
      const res = await fetch(`${API_BASE_URL}/teacher/archived-slots`, {
        headers: {
          Authorization: `Bearer ${localStorage.getItem('token')}`,
        },
      });
      const slots = await res.json();
      const slotDropdown = document.getElementById('archivedSlotFilter');

      slotDropdown.innerHTML = '<option value="">-- Select Archived Slot --</option>';

      slots.forEach(slot => {
        const option = document.createElement('option');
        option.value = slot;
        option.innerText = slot;
        slotDropdown.appendChild(option);
      });
    } catch (err) {
      console.error('Error fetching archived slots:', err);
    }
  }

  // ============ Fetch Archived Students by Slot ============

  async function fetchArchivedStudentsBySlot() {
    const selectedSlot = document.getElementById('archivedSlotFilter').value;
    if (!selectedSlot) {
      document.getElementById('archivedStudentList').innerHTML = '<p>Please select an archived slot to view students.</p>';
      return;
    }

    const url = `${API_BASE_URL}/teacher/archived-students?slot=${encodeURIComponent(selectedSlot)}`;

    try {
      const res = await fetch(url, {
        headers: {
          Authorization: `Bearer ${localStorage.getItem('token')}`,
        },
      });

      const students = await res.json();
      const container = document.getElementById('archivedStudentList');
      container.innerHTML = '';

      if (students.length === 0) {
        container.innerHTML = '<p>No archived students found for this slot.</p>';
        return;
      }

      // Render as table with unarchive button
      let tableHtml = `<table style="width:100%;border-collapse:collapse;table-layout: fixed;">
        <thead>
          <tr style="background:#e6f7ff;color:#0072ff;">
            <th style="padding:8px;">Reg No</th>
            <th style="padding:8px;">Name</th>
            <th style="padding:8px;">Email</th>
            <th style="padding:8px;">Active Slots</th>
            <th style="padding:8px;">Archived Slots</th>
            <th style="padding:8px;">Action</th>
          </tr>
        </thead>
        <tbody>`;
      students.forEach((stu, index) => {
        const activeSlots = Array.isArray(stu.slot) ? stu.slot.join(", ") : stu.slot || "None";
        const archivedSlots = Array.isArray(stu.archivedSlots) ? stu.archivedSlots.join(", ") : stu.archivedSlots || "None";
        
        tableHtml += `<tr style="border-bottom:1px solid #ffffff22;">
          <td style="padding: 12px 8px; vertical-align: middle;">${stu.regNo}</td>
          <td style="padding: 12px 8px; vertical-align: middle; word-wrap: break-word;">${stu.name}</td>
          <td style="padding: 12px 8px; vertical-align: middle; word-wrap: break-word;">${stu.email}</td>
          <td style="padding: 12px 8px; vertical-align: middle; word-wrap: break-word;">${activeSlots}</td>
          <td style="padding: 12px 8px; vertical-align: middle; word-wrap: break-word;">${archivedSlots}</td>
          <td style="padding: 12px 8px; vertical-align: middle;"><button onclick=\"unarchiveStudent('${stu.regNo}')\" style="background: linear-gradient(to right, #4caf50, #45a049);">Unarchive</button></td>
        </tr>`;
      });
      tableHtml += '</tbody></table>';
      container.innerHTML = tableHtml;
    } catch (err) {
      console.error('Error fetching archived students:', err);
      document.getElementById('archivedStudentList').innerHTML = 'Error loading archived students.';
    }
  }

  // ============ Unarchive Student ============

  async function unarchiveStudent(regNo) {
    const selectedSlot = document.getElementById('archivedSlotFilter').value;
    if (!confirm(`Unarchive student with RegNo: ${regNo} from slot: ${selectedSlot}?`)) return;

    try {
      const res = await fetch(`${API_BASE_URL}/teacher/unarchive-student/${regNo}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${localStorage.getItem("token")}`,
        },
        body: JSON.stringify({ slot: selectedSlot }),
      });

      const data = await res.json();
      if (res.ok) {
        alert(data.message || 'Student unarchived successfully');
        fetchArchivedStudentsBySlot();
        fetchArchivedSlots();
      } else {
        alert(data.message || 'Failed to unarchive student');
      }
    } catch (err) {
      console.error(err);
      alert('Error unarchiving student');
    }
  }

</script>

<script>
  // ============ Attendance Settings ============

  function handleMainSlotChange() {
    const mainSlot = document.getElementById("attendanceSlot").value;
    const individualSlotDropdown = document.getElementById("individualSlot");
    
    // Clear existing options
    individualSlotDropdown.innerHTML = '<option value="">-- Select Individual Slot --</option>';
    
    if (mainSlot) {
      // Split the main slot into individual slots
      let individualSlots = mainSlot.split(/[\+\-]/).map(s => s.trim()).filter(Boolean);
      
      // Add each individual slot as an option
      individualSlots.forEach(slot => {
        const option = document.createElement("option");
        option.value = slot;
        option.innerText = slot;
        individualSlotDropdown.appendChild(option);
      });
    }
  }

  function saveAttendanceSettings() {
    const mainSlot = document.getElementById("attendanceSlot").value;
    const individualSlot = document.getElementById("individualSlot").value;
    const radius = document.getElementById("radiusInput").value;
    const latitude = document.getElementById("latitude").value;
    const longitude = document.getElementById("longitude").value;
    const startTime = document.getElementById("startTimeInput").value;
    const endTime = document.getElementById("endTimeInput").value;

    if (!mainSlot || !individualSlot) {
      alert("Please select both main slot and individual slot");
      return;
    }

    if (!radius || !startTime || !endTime || !latitude || !longitude) {
      alert("Please complete all fields, including location.");
      return;
    }

    const today = new Date().toISOString().split('T')[0];
    const data = { 
      radius, 
      latitude, 
      longitude, 
      startTime, 
      endTime, 
      mainSlot,
      individualSlot,
      date: today 
    };

    fetch(`${API_BASE_URL}/teacher/attendance-settings`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${localStorage.getItem("token")}`,
      },
      body: JSON.stringify(data),
    })
      .then(res => res.json())
      .then(data => {
        document.getElementById("radiusSavedMsg").innerText =
          data.message || "Attendance settings saved!";
        // Show live count section and start polling
        showLiveCount(mainSlot, individualSlot);
      })
      .catch(err => {
        console.error("Error saving settings:", err);
        alert("Something went wrong.");
      });
  }

  async function populateAttendanceSlotDropdown() {
    try {
      const res = await fetch(`${API_BASE_URL}/teacher/slots`, {
        headers: {
          Authorization: `Bearer ${localStorage.getItem("token")}`,
        }
      });
      const slots = await res.json();
      const dropdown = document.getElementById("attendanceSlot");
      dropdown.innerHTML = '<option value="">-- Select Slot --</option>';
      slots.forEach(slot => {
        const option = document.createElement("option");
        option.value = slot;
        option.innerText = slot;
        dropdown.appendChild(option);
      });
    } catch (err) {
      console.error("Failed to fetch slots:", err);
    }
  }

</script>

<script>
  // Populate slot dropdown
  async function populateDownloadMainSlots() {
    try {
      const res = await fetch(`${API_BASE_URL}/teacher/slots`, {
        headers: {
          Authorization: `Bearer ${localStorage.getItem("token")}`
        }
      });
      const slots = await res.json();
      const slotDropdown = document.getElementById("downloadMainSlot");

      slotDropdown.innerHTML = '<option value="">-- Select Main Slot --</option>';
      slots.forEach(slot => {
        const option = document.createElement('option');
        option.value = slot;
        option.innerText = slot;
        slotDropdown.appendChild(option);
      });
    } catch (err) {
      console.error("Failed to fetch slots", err);
    }
  }

  function handleDownloadMainSlotChange() {
    const mainSlot = document.getElementById('downloadMainSlot').value;
    const individualSlotDropdown = document.getElementById('downloadIndividualSlot');
    individualSlotDropdown.innerHTML = '<option value="">-- Select Individual Slot --</option>';
    
    if (mainSlot) {
      const individualSlots = mainSlot.split('+');
      individualSlots.forEach(slot => {
        const option = document.createElement("option");
        option.value = slot.trim();
        option.textContent = slot.trim();
        individualSlotDropdown.appendChild(option);
      });
    }
  }

  // ============ Download Sheet Function ============
  async function downloadSheet() {
    const mainSlot = document.getElementById('downloadMainSlot').value;
    const individualSlot = document.getElementById('downloadIndividualSlot').value;
    const date = document.getElementById('downloadDate').value;
    const messageDiv = document.getElementById('download-message');
    const token = localStorage.getItem('token');

    if (!mainSlot || !individualSlot || !date) {
      messageDiv.textContent = 'Please select a main slot, individual slot, and a date.';
      messageDiv.style.color = '#ff4f4f';
      return;
    }
    messageDiv.textContent = 'Generating report...';
    messageDiv.style.color = '#ccc';

    try {
      const res = await fetch(`${API_BASE_URL}/teacher/attendance-report?mainSlot=${encodeURIComponent(mainSlot)}&individualSlot=${encodeURIComponent(individualSlot)}&date=${date}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!res.ok) {
        const errorData = await res.json();
        throw new Error(errorData.message || 'Failed to download report.');
      }

      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `Attendance-${mainSlot.replace(/\+/g, '_')}-${individualSlot}-${date}.xlsx`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
      
      messageDiv.textContent = 'Report downloaded successfully!';
      messageDiv.style.color = '#4caf50';

    } catch (err) {
      console.error("Download error:", err);
      messageDiv.textContent = `Error: ${err.message}`;
      messageDiv.style.color = '#ff4f4f';
    }
  }

</script>

<script>
  let liveCountInterval = null;
  function showLiveCount(mainSlot, individualSlot) {
    const section = document.getElementById('live-count-section');
    const loading = document.getElementById('live-count-loading');
    const display = document.getElementById('live-count-display');
    section.style.display = 'block';
    loading.style.display = 'inline';
    display.style.display = 'none';
    if (liveCountInterval) clearInterval(liveCountInterval);
    async function fetchLiveCount() {
      try {
        const res = await fetch(`${API_BASE_URL}/teacher/attendance-live-count?mainSlot=${encodeURIComponent(mainSlot)}&individualSlot=${encodeURIComponent(individualSlot)}`, {
          headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
        });
        const data = await res.json();
        if (res.ok) {
          loading.style.display = 'none';
          display.style.display = 'inline';
          display.innerHTML = `Present: <span style='color:green;'>${data.present}</span> / Total: <span style='color:blue;'>${data.total}</span> &nbsp; | &nbsp; Absent: <span style='color:red;'>${data.absent}</span>`;
        } else {
          loading.style.display = 'inline';
          display.style.display = 'none';
          loading.textContent = data.message || 'Error loading live count';
        }
      } catch (err) {
        loading.style.display = 'inline';
        display.style.display = 'none';
        loading.textContent = 'Error loading live count';
      }
    }
    fetchLiveCount();
    liveCountInterval = setInterval(fetchLiveCount, 2000);
  }
</script>

<script>
  // Tab switching/blocking
  document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
      alert('Tab switching is not allowed! You will be logged out.');
      localStorage.clear();
      window.location.href = 'index.html';
    }
  });
</script>

</body>
</html>